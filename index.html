<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatLunaç»ˆç«¯æ¥å£</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: #00ff00;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            height: 100vh;
            overflow: hidden;
        }

        /* éšè—æ‰€æœ‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            display: none;
        }

        * {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        #matrix-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #terminal {
            position: relative;
            height: 100vh;
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        .terminal-header {
            background: rgba(30, 30, 46, 0.9);
            padding: 10px 20px;
            border-bottom: 1px solid #00ff00;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .terminal-title {
            color: #00ff00;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 0 0 10px #00ff00;
        }

        .terminal-status {
            color: #888;
            font-size: 12px;
        }

        .terminal-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.8);
        }

        .output-line {
            margin-bottom: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .system-msg {
            color: #ffd700;
        }

        .error-msg {
            color: #ff4444;
        }

        .success-msg {
            color: #44ff44;
        }

        .info-msg {
            color: #4488ff;
        }

        .ai-msg {
            color: #66ffff;
            padding: 5px;
            border-left: 2px solid #66ffff;
            margin: 5px 0;
        }

        .prompt {
            color: #00ff00;
            font-weight: bold;
        }

        .input-section {
            background: rgba(30, 30, 46, 0.9);
            padding: 15px 20px;
            border-top: 1px solid #00ff00;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-prompt {
            color: #00ff00;
            font-weight: bold;
            user-select: none;
        }

        #command-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #00ff00;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            outline: none;
            padding: 5px 0;
        }

        #command-input::placeholder {
            color: #666;
        }

        .cursor {
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }

        .help-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(30, 30, 46, 0.95);
            border: 1px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
            max-width: 300px;
            max-height: calc(100vh - 200px);
            overflow: hidden;
            display: none;
            z-index: 1000;
        }

        .help-content {
            max-height: calc(100vh - 240px);
            overflow-y: auto;
        }

        .help-title {
            color: #00ff00;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .help-category {
            color: #ffd700;
            font-weight: bold;
            margin: 10px 0 5px 0;
            border-bottom: 1px solid #444;
        }

        .help-command {
            color: #4488ff;
            margin: 2px 0;
            font-size: 12px;
            cursor: pointer;
        }

        .help-command:hover {
            color: #66aaff;
            background: rgba(68, 136, 255, 0.1);
        }

        .autocomplete {
            position: absolute;
            bottom: 60px;
            left: 20px;
            right: 20px;
            background: rgba(30, 30, 46, 0.95);
            border: 1px solid #00ff00;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .autocomplete-item {
            padding: 8px 12px;
            color: #00ff00;
            cursor: pointer;
            border-bottom: 1px solid #333;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: rgba(0, 255, 0, 0.1);
        }
    </style>
</head>

<body>
    <canvas id="matrix-canvas"></canvas>

    <div id="terminal">
        <div class="terminal-header">
            <div class="terminal-title">ChatLuna Terminal Interface v2.0</div>
            <div class="terminal-status" id="status">Status: ONLINE | Model: gemini-2.5-flash | Room: é»˜è®¤æˆ¿é—´ | Preset:
                chatgpt</div>
        </div>

        <div class="terminal-body" id="output"></div>

        <div class="input-section">
            <span class="input-prompt">chatluna@terminal:~$</span>
            <input type="text" id="command-input" placeholder="è¾“å…¥å‘½ä»¤... (Tabè‡ªåŠ¨è¡¥å…¨, F1æ˜¾ç¤ºå¸®åŠ©)" autocomplete="off">
            <span class="cursor" id="cursor">â–ˆ</span>
        </div>
    </div>

    <div class="help-panel" id="help-panel">
        <div class="help-content">
            <div class="help-title">ChatLuna å‘½ä»¤å‚è€ƒ</div>
            <div class="help-category">å¯¹è¯å‘½ä»¤</div>
            <div class="help-command" onclick="insertCommand('chatluna.chat.text')">chatluna.chat.text - æ–‡æœ¬å¯¹è¯</div>
            <div class="help-command" onclick="insertCommand('chatluna.chat.voice')">chatluna.chat.voice - è¯­éŸ³å¯¹è¯</div>
            <div class="help-command" onclick="insertCommand('chatluna.chat.stop')">chatluna.chat.stop - åœæ­¢å¯¹è¯</div>
            <div class="help-command" onclick="insertCommand('chatluna.chat.rollback')">chatluna.chat.rollback - å›æ»šå¯¹è¯
            </div>

            <div class="help-category">æˆ¿é—´ç®¡ç†</div>
            <div class="help-command" onclick="insertCommand('chatluna.room.create')">chatluna.room.create - åˆ›å»ºæˆ¿é—´</div>
            <div class="help-command" onclick="insertCommand('chatluna.room.switch')">chatluna.room.switch - åˆ‡æ¢æˆ¿é—´</div>
            <div class="help-command" onclick="insertCommand('chatluna.room.set')">chatluna.room.set - è®¾ç½®æˆ¿é—´</div>
            <div class="help-command" onclick="insertCommand('chatluna.room.delete')">chatluna.room.delete - åˆ é™¤æˆ¿é—´</div>
            <div class="help-command" onclick="insertCommand('chatluna.room.list')">chatluna.room.list - æˆ¿é—´åˆ—è¡¨</div>
            <div class="help-command" onclick="insertCommand('chatluna.room.info')">chatluna.room.info - æˆ¿é—´ä¿¡æ¯</div>
            <div class="help-command" onclick="insertCommand('chatluna.room.clear')">chatluna.room.clear - æ¸…ç©ºè®°å½•</div>

            <div class="help-category">æ¨¡å‹ç®¡ç†</div>
            <div class="help-command" onclick="insertCommand('chatluna.model.list')">chatluna.model.list - æ¨¡å‹åˆ—è¡¨</div>
            <div class="help-command" onclick="insertCommand('chatluna.model.search')">chatluna.model.search - æœç´¢æ¨¡å‹
            </div>

            <div class="help-category">é¢„è®¾ç®¡ç†</div>
            <div class="help-command" onclick="insertCommand('chatluna.preset.list')">chatluna.preset.list - é¢„è®¾åˆ—è¡¨</div>
            <div class="help-command" onclick="insertCommand('chatluna.preset.add')">chatluna.preset.add - æ·»åŠ é¢„è®¾</div>
            <div class="help-command" onclick="insertCommand('chatluna.preset.set')">chatluna.preset.set - è®¾ç½®é¢„è®¾</div>
            <div class="help-command" onclick="insertCommand('chatluna.preset.delete')">chatluna.preset.delete - åˆ é™¤é¢„è®¾
            </div>

            <div class="help-category">ç³»ç»Ÿå‘½ä»¤</div>
            <div class="help-command" onclick="insertCommand('chatluna.restart')">chatluna.restart - é‡å¯æ’ä»¶</div>
            <div class="help-command" onclick="insertCommand('chatluna.wipe')">chatluna.wipe - é‡ç½®æ•°æ®</div>
            <div class="help-command" onclick="insertCommand('clear')">clear - æ¸…å±</div>
            <div class="help-command" onclick="insertCommand('help')">help - æ˜¾ç¤ºå¸®åŠ©</div>
        </div>
    </div>

    <div class="autocomplete" id="autocomplete"></div>

    <script>
        // Matrix Rain Effect
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const matrix = "ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789@#$%^&*()*&^%+-/~{[|`]}";
        const matrixArray = matrix.split("");

        const fontSize = 10;
        const columns = canvas.width / fontSize;

        const drops = [];
        for (let x = 0; x < columns; x++) {
            drops[x] = 1;
        }

        function draw() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.04)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#00ff00';
            ctx.font = fontSize + 'px monospace';

            for (let i = 0; i < drops.length; i++) {
                const text = matrixArray[Math.floor(Math.random() * matrixArray.length)];
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);

                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                    drops[i] = 0;
                }
                drops[i]++;
            }
        }

        setInterval(draw, 35);

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // APIé…ç½®
        const API_BASE = 'https://api.kongbai.me/v1';
        const API_KEY = 'sk-WjIgedsrkifCImIIemzlRuRx9mqfr6U6eGgIjFyKV5wjgHT4';
        const MODEL_NAME = 'gemini-2.5-flash';

        // å…¨å±€çŠ¶æ€
        let isWaitingForVerification = false;
        let isWaitingForConfirmation = false;
        let isWaitingForPresetContent = false;
        let confirmationAction = null;
        let confirmationData = null;
        let verificationAnswer = 0;
        let currentRoomId = '001';
        let currentStreamController = null;
        let pendingPresetName = null;

        // é¢„è®¾ç³»ç»Ÿ
        let presets = {
            'chatgpt': 'You are ChatGPT, a helpful AI assistant.',
            'catgirl': 'ä½ æ˜¯ä¸€åªå¯çˆ±çš„çŒ«å¨˜ï¼Œè¯´è¯æ—¶ä¼šåœ¨å¥å°¾åŠ ä¸Š"å–µ~"ï¼Œæ€§æ ¼æ´»æ³¼å¯çˆ±ã€‚',
            'assistant': 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å•†åŠ¡åŠ©æ‰‹ï¼Œå›ç­”ç®€æ´ã€å‡†ç¡®ã€æ­£å¼ã€‚',
            'translator': 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¿»è¯‘åŠ©æ‰‹ï¼Œèƒ½å¤Ÿå‡†ç¡®ç¿»è¯‘å„ç§è¯­è¨€ã€‚',
            'programmer': 'ä½ æ˜¯ä¸€ä¸ªç¼–ç¨‹ä¸“å®¶ï¼Œç²¾é€šå„ç§ç¼–ç¨‹è¯­è¨€ï¼Œå–„äºè§£å†³æŠ€æœ¯é—®é¢˜ã€‚',
            'teacher': 'ä½ æ˜¯ä¸€ä¸ªè€å¿ƒçš„è€å¸ˆï¼Œå–„äºç”¨ç®€å•æ˜“æ‡‚çš„æ–¹å¼è§£é‡Šå¤æ‚çš„æ¦‚å¿µã€‚',
            'creative': 'ä½ æ˜¯ä¸€ä¸ªå¯Œæœ‰åˆ›æ„çš„å†™ä½œåŠ©æ‰‹ï¼Œæ“…é•¿åˆ›ä½œæ•…äº‹ã€è¯—æ­Œå’Œå„ç§æ–‡å­¦ä½œå“ã€‚'
        };

        // æˆ¿é—´ç³»ç»Ÿ
        let rooms = {
            '001': {
                name: 'é»˜è®¤æˆ¿é—´',
                model: 'gemini-2.5-flash',
                preset: 'chatgpt',
                history: [],
                created: new Date().toISOString()
            },
            '002': {
                name: 'å·¥ä½œæˆ¿é—´',
                model: 'gemini-2.5-flash',
                preset: 'assistant',
                history: [],
                created: new Date().toISOString()
            },
            '003': {
                name: 'å¨±ä¹æˆ¿é—´',
                model: 'gemini-2.5-flash',
                preset: 'catgirl',
                history: [],
                created: new Date().toISOString()
            }
        };

        // å¯ç”¨æ¨¡å‹åˆ—è¡¨
        const availableModels = [
            { name: 'gemini-2.5-flash', provider: 'Google', status: 'åœ¨çº¿', description: 'å¿«é€Ÿå“åº”æ¨¡å‹' },
            { name: 'gemini-1.5-pro', provider: 'Google', status: 'ç¦»çº¿', description: 'é«˜çº§æ¨ç†æ¨¡å‹' },
            { name: 'gpt-4-turbo', provider: 'OpenAI', status: 'ç¦»çº¿', description: 'æœ€æ–°GPT-4æ¨¡å‹' },
            { name: 'gpt-3.5-turbo', provider: 'OpenAI', status: 'ç¦»çº¿', description: 'å¿«é€Ÿå“åº”æ¨¡å‹' },
            { name: 'claude-3-sonnet', provider: 'Anthropic', status: 'ç¦»çº¿', description: 'å¹³è¡¡æ€§èƒ½æ¨¡å‹' },
            { name: 'ChatGLM-Pro', provider: 'æ™ºè°±AI', status: 'ç¦»çº¿', description: 'ä¸­æ–‡ä¼˜åŒ–æ¨¡å‹' }
        ];

        const commands = [
            'chatluna',
            'chatluna.chat',
            'chatluna.chat.text',
            'chatluna.chat.voice',
            'chatluna.chat.stop',
            'chatluna.chat.rollback',
            'chatluna.room',
            'chatluna.room.create',
            'chatluna.room.switch',
            'chatluna.room.set',
            'chatluna.room.delete',
            'chatluna.room.list',
            'chatluna.room.info',
            'chatluna.room.clear',
            'chatluna.room.auto-update',
            'chatluna.room.transfer',
            'chatluna.room.invite',
            'chatluna.room.leave',
            'chatluna.room.kick',
            'chatluna.room.permission',
            'chatluna.room.mute',
            'chatluna.room.join',
            'chatluna.model',
            'chatluna.model.list',
            'chatluna.model.search',
            'chatluna.preset',
            'chatluna.preset.list',
            'chatluna.preset.add',
            'chatluna.preset.set',
            'chatluna.preset.delete',
            'chatluna.preset.clone',
            'chatluna.embeddings',
            'chatluna.embeddings.list',
            'chatluna.embeddings.set',
            'chatluna.vectorstore',
            'chatluna.vectorstore.list',
            'chatluna.vectorstore.set',
            'chatluna.restart',
            'chatluna.wipe',
            'chatluna.balance.query',
            'chatluna.balance.clear',
            'chatluna.balance.set',
            'chatluna.auth.add',
            'chatluna.auth.kick',
            'chatluna.auth.create',
            'chatluna.auth.list',
            'clear',
            'help',
            'exit',
            'chat',
            'preset'
        ];

        const output = document.getElementById('output');
        const input = document.getElementById('command-input');
        const helpPanel = document.getElementById('help-panel');
        const autocomplete = document.getElementById('autocomplete');
        const statusElement = document.getElementById('status');

        let commandHistory = [];
        let historyIndex = -1;
        let selectedAutocomplete = -1;

        // æ›´æ–°çŠ¶æ€æ 
        function updateStatus() {
            const currentRoom = rooms[currentRoomId];
            statusElement.textContent = `Status: ONLINE | Model: ${currentRoom.model} | Room: ${currentRoom.name} | Preset: ${currentRoom.preset}`;
        }

        // æµå¼APIè°ƒç”¨
        async function callAIStream(message, onChunk, onComplete, onError) {
            let currentAiLine = null;
            let fullResponse = '';

            try {
                const messages = [];
                const currentRoom = rooms[currentRoomId];

                if (presets[currentRoom.preset]) {
                    messages.push({ role: 'system', content: presets[currentRoom.preset] });
                }

                messages.push(...currentRoom.history);
                messages.push({ role: 'user', content: message });

                const controller = new AbortController();
                currentStreamController = controller;

                const response = await fetch(`${API_BASE}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: currentRoom.model,
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 1000,
                        stream: true
                    }),
                    signal: controller.signal
                });

                if (!response.ok) {
                    throw new Error(`APIé”™è¯¯: ${response.status} - ${response.statusText}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                currentAiLine = document.createElement('div');
                currentAiLine.className = 'output-line ai-msg';
                currentAiLine.textContent = 'AIå›å¤: ';
                output.appendChild(currentAiLine);

                while (true) {
                    const { done, value } = await reader.read();

                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.trim() === '' || line.trim() === 'data: [DONE]') continue;

                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                const content = data.choices?.[0]?.delta?.content || '';

                                if (content) {
                                    fullResponse += content;
                                    currentAiLine.textContent = 'AIå›å¤: ' + fullResponse;
                                    output.scrollTop = output.scrollHeight;
                                    onChunk?.(content);
                                }
                            } catch (e) {
                                console.warn('è§£ææµæ•°æ®å¤±è´¥:', e);
                            }
                        }
                    }
                }

                currentRoom.history.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content: fullResponse }
                );

                if (currentRoom.history.length > 20) {
                    currentRoom.history = currentRoom.history.slice(-20);
                }

                onComplete?.(fullResponse);

            } catch (error) {
                if (error.name === 'AbortError') {
                    if (currentAiLine) {
                        currentAiLine.textContent += ' [å·²ä¸­æ­¢]';
                    }
                    addOutput('error-msg', 'å¯¹è¯å·²ä¸­æ­¢');
                } else {
                    console.error('APIè°ƒç”¨é”™è¯¯:', error);
                    if (currentAiLine) {
                        currentAiLine.remove();
                    }

                    let errorMsg = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œçŠ¶æ€';
                    if (error.message.includes('timeout')) {
                        errorMsg = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•';
                    } else if (error.message.includes('401')) {
                        errorMsg = 'APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ';
                    } else if (error.message.includes('429')) {
                        errorMsg = 'è¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åé‡è¯•';
                    } else if (error.message.includes('500')) {
                        errorMsg = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                    }

                    addOutput('error-msg', `APIè°ƒç”¨å¤±è´¥: ${errorMsg}`);
                    onError?.(error);
                }
            } finally {
                currentStreamController = null;
            }
        }

        // æˆ¿é—´ç®¡ç†å‡½æ•°
        function switchRoom(roomId) {
            if (!rooms[roomId]) {
                addOutput('error-msg', `æˆ¿é—´ ${roomId} ä¸å­˜åœ¨`);
                return false;
            }

            currentRoomId = roomId;
            updateStatus();
            return true;
        }

        function createRoom(name, model = 'gemini-2.5-flash', preset = 'chatgpt') {
            const roomId = Date.now().toString();
            rooms[roomId] = {
                name: name,
                model: model,
                preset: preset,
                history: [],
                created: new Date().toISOString()
            };
            return roomId;
        }

        // åˆå§‹åŒ–
        function init() {
            addOutput('system-msg', '='.repeat(60));
            addOutput('system-msg', '       ChatLuna Terminal Interface v2.0');
            addOutput('system-msg', '       æ¬¢è¿ä½¿ç”¨ ChatLuna å‘½ä»¤ç»ˆç«¯');
            addOutput('system-msg', '='.repeat(60));
            addOutput('info-msg', 'æç¤ºï¼š');
            addOutput('info-msg', 'â€¢ è¾“å…¥ "help" æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å‘½ä»¤');
            addOutput('info-msg', 'â€¢ æŒ‰ Tab é”®è‡ªåŠ¨è¡¥å…¨å‘½ä»¤');
            addOutput('info-msg', 'â€¢ æŒ‰ F1 æ˜¾ç¤º/éšè—å¸®åŠ©é¢æ¿');
            addOutput('info-msg', 'â€¢ æŒ‰ â†‘â†“ é”®æµè§ˆå‘½ä»¤å†å²');
            addOutput('info-msg', 'â€¢ è¾“å…¥ "clear" æ¸…å±');
            addOutput('info-msg', 'â€¢ æ”¯æŒæµå¼å¯¹è¯ï¼Œå®æ—¶æ˜¾ç¤ºAIå›å¤');
            addOutput('info-msg', '');
            addOutput('success-msg', 'ç³»ç»Ÿå·²å°±ç»ªï¼Œç­‰å¾…è¾“å…¥å‘½ä»¤...');
            addOutput('', '');
            updateStatus();
        }

        function addOutput(className, text) {
            const line = document.createElement('div');
            line.className = `output-line ${className}`;
            line.textContent = text;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        // æ‰§è¡Œç¡®è®¤æ“ä½œ
        function executeConfirmAction(confirmed) {
            if (confirmed) {
                switch (confirmationAction) {
                    case 'delete_room':
                        const { roomId } = confirmationData;
                        delete rooms[roomId];
                        if (roomId === currentRoomId) {
                            currentRoomId = Object.keys(rooms)[0];
                            updateStatus();
                            addOutput('info-msg', `å·²è‡ªåŠ¨åˆ‡æ¢åˆ°æˆ¿é—´: ${rooms[currentRoomId].name}`);
                        }
                        addOutput('success-msg', 'æˆ¿é—´åˆ é™¤æˆåŠŸ');
                        break;

                    case 'delete_preset':
                        const { presetName } = confirmationData;
                        delete presets[presetName];
                        if (rooms[currentRoomId].preset === presetName) {
                            rooms[currentRoomId].preset = 'chatgpt';
                            rooms[currentRoomId].history = [];
                            updateStatus();
                            addOutput('info-msg', 'å·²è‡ªåŠ¨åˆ‡æ¢åˆ°é»˜è®¤é¢„è®¾: chatgpt');
                        }
                        addOutput('success-msg', `é¢„è®¾ "${presetName}" å·²åˆ é™¤`);
                        break;
                }
            } else {
                addOutput('info-msg', 'æ“ä½œå·²å–æ¶ˆ');
            }

            isWaitingForConfirmation = false;
            confirmationAction = null;
            confirmationData = null;
        }

        function processCommand(cmd) {
            const trimmed = cmd.trim();
            if (!trimmed) return;

            // å¦‚æœæ­£åœ¨ç­‰å¾…é¢„è®¾å†…å®¹è¾“å…¥
            if (isWaitingForPresetContent) {
                addOutput('prompt', `chatluna@terminal:~$ ${trimmed}`);
                
                if (trimmed.toLowerCase() === '/cancel') {
                    addOutput('info-msg', 'é¢„è®¾åˆ›å»ºå·²å–æ¶ˆ');
                    isWaitingForPresetContent = false;
                    pendingPresetName = null;
                } else if (trimmed.toLowerCase() === '/end') {
                    addOutput('error-msg', 'é”™è¯¯: é¢„è®¾å†…å®¹ä¸èƒ½ä¸ºç©º');
                    addOutput('info-msg', 'è¯·è¾“å…¥é¢„è®¾å†…å®¹ï¼Œæˆ–è¾“å…¥ /cancel å–æ¶ˆåˆ›å»º');
                } else {
                    // ä¿å­˜é¢„è®¾
                    presets[pendingPresetName] = trimmed;
                    addOutput('success-msg', `é¢„è®¾ "${pendingPresetName}" åˆ›å»ºæˆåŠŸ`);
                    addOutput('info-msg', `é¢„è®¾å†…å®¹: ${trimmed.substring(0, 50)}${trimmed.length > 50 ? '...' : ''}`);
                    addOutput('info-msg', `ä½¿ç”¨ preset ${pendingPresetName} æˆ– chatluna.preset.set ${pendingPresetName} æ¥åˆ‡æ¢åˆ°æ­¤é¢„è®¾`);
                    
                    isWaitingForPresetContent = false;
                    pendingPresetName = null;
                }
                addOutput('', '');
                return;
            }

            // å¦‚æœæ­£åœ¨ç­‰å¾…æ•°å­¦éªŒè¯
            if (isWaitingForVerification) {
                const userAnswer = parseInt(trimmed);
                addOutput('prompt', `chatluna@terminal:~$ ${trimmed}`);

                if (userAnswer === verificationAnswer) {
                    addOutput('success-msg', 'éªŒè¯é€šè¿‡ï¼Œå¼€å§‹æ•°æ®æ¸…ç†...');
                    addOutput('info-msg', 'æ­£åœ¨æ¸…é™¤æ•°æ®åº“...');

                    Object.keys(rooms).forEach(roomId => {
                        rooms[roomId].history = [];
                    });

                    setTimeout(() => {
                        addOutput('success-msg', 'ç³»ç»Ÿé‡ç½®å®Œæˆï¼');
                        addOutput('info-msg', 'ChatLunaå·²æ¢å¤åˆ°åˆå§‹çŠ¶æ€');
                    }, 1500);
                } else {
                    addOutput('error-msg', 'éªŒè¯å¤±è´¥ï¼Œæ“ä½œå·²å–æ¶ˆ');
                    addOutput('info-msg', 'æ•°å­¦ç­”æ¡ˆä¸æ­£ç¡®ï¼Œç³»ç»Ÿä¿æŒåŸçŠ¶');
                }

                isWaitingForVerification = false;
                verificationAnswer = 0;
                addOutput('', '');
                return;
            }

            // å¦‚æœæ­£åœ¨ç­‰å¾…Y/Nç¡®è®¤
            if (isWaitingForConfirmation) {
                addOutput('prompt', `chatluna@terminal:~$ ${trimmed}`);
                const answer = trimmed.toLowerCase();

                if (answer === 'y' || answer === 'yes') {
                    executeConfirmAction(true);
                } else if (answer === 'n' || answer === 'no') {
                    executeConfirmAction(false);
                } else {
                    addOutput('error-msg', 'è¯·è¾“å…¥ Y/N æˆ– yes/no');
                    return;
                }

                addOutput('', '');
                return;
            }

            // æ·»åŠ åˆ°å†å²
            commandHistory.unshift(trimmed);
            if (commandHistory.length > 50) {
                commandHistory.pop();
            }
            historyIndex = -1;

            // æ˜¾ç¤ºç”¨æˆ·è¾“å…¥
            addOutput('prompt', `chatluna@terminal:~$ ${trimmed}`);

            // å¤„ç†å‘½ä»¤
            const args = trimmed.split(' ');
            const mainCmd = args[0];

            switch (mainCmd) {
                case 'clear':
                    output.innerHTML = '';
                    break;

                case 'help':
                    showHelp();
                    break;

                case 'exit':
                    addOutput('system-msg', 'æ„Ÿè°¢ä½¿ç”¨ ChatLuna Terminalï¼');
                    setTimeout(() => {
                        window.close();
                    }, 1000);
                    break;

                case 'chat':
                    const directMessage = args.slice(1).join(' ');
                    if (directMessage) {
                        addOutput('success-msg', `å‘é€æ¶ˆæ¯: "${directMessage}"`);
                        addOutput('info-msg', 'æ­£åœ¨è¿æ¥AIæ¨¡å‹...');
                        callAIStream(directMessage);
                    } else {
                        addOutput('error-msg', 'è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                        addOutput('info-msg', 'ç”¨æ³•: chat <ä½ çš„æ¶ˆæ¯>');
                    }
                    break;

                case 'preset':
                    const presetArg = args[1];
                    const currentRoom = rooms[currentRoomId];
                    if (!presetArg) {
                        addOutput('info-msg', 'å½“å‰é¢„è®¾: ' + currentRoom.preset);
                        addOutput('info-msg', 'å¯ç”¨é¢„è®¾: ' + Object.keys(presets).join(', '));
                        addOutput('info-msg', 'ç”¨æ³•: preset <é¢„è®¾å> æ¥åˆ‡æ¢');
                    } else if (presets[presetArg]) {
                        currentRoom.preset = presetArg;
                        currentRoom.history = [];
                        updateStatus();
                        addOutput('success-msg', `å·²åˆ‡æ¢åˆ°é¢„è®¾: ${presetArg}`);
                        addOutput('info-msg', 'èŠå¤©å†å²å·²é‡ç½®');
                    } else {
                        addOutput('error-msg', `é¢„è®¾ "${presetArg}" ä¸å­˜åœ¨`);
                        addOutput('info-msg', 'å¯ç”¨é¢„è®¾: ' + Object.keys(presets).join(', '));
                    }
                    break;

                default:
                    if (mainCmd.startsWith('chatluna')) {
                        simulateChatluna(trimmed);
                    } else {
                        addOutput('error-msg', `é”™è¯¯: æœªçŸ¥å‘½ä»¤ '${mainCmd}'`);
                        addOutput('info-msg', 'è¾“å…¥ "help" æŸ¥çœ‹å¯ç”¨å‘½ä»¤');
                    }
            }

            addOutput('', '');
        }

        function showHelp() {
            addOutput('system-msg', 'ChatLuna å‘½ä»¤å¸®åŠ©');
            addOutput('system-msg', '='.repeat(40));
            addOutput('info-msg', 'å¯¹è¯å‘½ä»¤:');
            addOutput('', '  chatluna.chat.text [message]     - å‘é€æ–‡æœ¬æ¶ˆæ¯');
            addOutput('', '  chat [message]                   - ç®€åŒ–èŠå¤©å‘½ä»¤');
            addOutput('', '  chatluna.chat.stop               - åœæ­¢å½“å‰å¯¹è¯');
            addOutput('', '  chatluna.chat.rollback           - å›æ»šä¸Šä¸€æ¡æ¶ˆæ¯');
            addOutput('', '');
            addOutput('info-msg', 'æˆ¿é—´ç®¡ç†:');
            addOutput('', '  chatluna.room.create             - åˆ›å»ºæ–°æˆ¿é—´');
            addOutput('', '  chatluna.room.switch <room>      - åˆ‡æ¢æˆ¿é—´');
            addOutput('', '  chatluna.room.set                - è®¾ç½®æˆ¿é—´å±æ€§');
            addOutput('', '  chatluna.room.list               - åˆ—å‡ºæˆ¿é—´');
            addOutput('', '  chatluna.room.clear              - æ¸…ç©ºèŠå¤©è®°å½•');
            addOutput('', '');
            addOutput('info-msg', 'æ¨¡å‹å’Œé¢„è®¾:');
            addOutput('', '  chatluna.model.list              - åˆ—å‡ºå¯ç”¨æ¨¡å‹');
            addOutput('', '  chatluna.model.search <keyword>  - æœç´¢æ¨¡å‹');
            addOutput('', '  chatluna.preset.list             - åˆ—å‡ºé¢„è®¾');
            addOutput('', '  preset <name>                    - åˆ‡æ¢é¢„è®¾');
            addOutput('', '');
            addOutput('info-msg', 'ç³»ç»Ÿå‘½ä»¤:');
            addOutput('', '  chatluna.restart                 - é‡å¯æ’ä»¶');
            addOutput('', '  chatluna.wipe                    - é‡ç½®æ‰€æœ‰æ•°æ®');
            addOutput('', '  clear                            - æ¸…å±');
            addOutput('', '  help                             - æ˜¾ç¤ºæ­¤å¸®åŠ©');
            addOutput('', '  exit                             - é€€å‡ºç»ˆç«¯');
        }

        async function simulateChatluna(cmd) {
            const args = cmd.split(' ');
            const currentRoom = rooms[currentRoomId];

            if (cmd === 'chatluna') {
                addOutput('system-msg', 'ChatLuna v3.0.8 - AI å¯¹è¯ç®¡ç†ç³»ç»Ÿ');
                addOutput('info-msg', 'ç‰ˆæœ¬ä¿¡æ¯: æ ¸å¿ƒæ¨¡å—å·²åŠ è½½');
                addOutput('success-msg', `å½“å‰çŠ¶æ€: åœ¨çº¿ | å¯ç”¨æ¨¡å‹: ${currentRoom.model} | æ´»è·ƒæˆ¿é—´: ${Object.keys(rooms).length}`);
                addOutput('', '');
                addOutput('info-msg', 'å¸¸ç”¨å‘½ä»¤:');
                addOutput('', '  chatluna.chat.text <æ¶ˆæ¯>  - å¼€å§‹å¯¹è¯');
                addOutput('', '  chatluna.room.list        - æŸ¥çœ‹æˆ¿é—´');
                addOutput('', '  chatluna.model.list       - æŸ¥çœ‹æ¨¡å‹');
                return;
            }

            if (cmd.startsWith('chatluna.chat.text')) {
                const message = args.slice(1).join(' ');
                if (!message) {
                    addOutput('error-msg', 'é”™è¯¯: è¯·è¾“å…¥è¦å‘é€çš„æ¶ˆæ¯');
                    addOutput('info-msg', 'ç”¨æ³•: chatluna.chat.text <ä½ çš„æ¶ˆæ¯>');
                    return;
                }

                addOutput('success-msg', `å‘é€æ¶ˆæ¯: "${message}"`);
                addOutput('info-msg', 'æ­£åœ¨è¿æ¥AIæ¨¡å‹...');
                addOutput('system-msg', `ä½¿ç”¨æ¨¡å‹: ${currentRoom.model} | æˆ¿é—´: ${currentRoom.name}`);

                await callAIStream(message);
                return;
            }

            if (cmd === 'chatluna.chat.stop') {
                if (currentStreamController) {
                    currentStreamController.abort();
                    addOutput('success-msg', 'å·²åœæ­¢å½“å‰å¯¹è¯');
                } else {
                    addOutput('info-msg', 'å½“å‰æ²¡æœ‰è¿›è¡Œä¸­çš„å¯¹è¯');
                }
                return;
            }

            if (cmd === 'chatluna.chat.rollback') {
                if (currentRoom.history.length >= 2) {
                    currentRoom.history = currentRoom.history.slice(0, -2);
                    addOutput('success-msg', 'å¯¹è¯å·²å›æ»š');
                    addOutput('info-msg', 'å·²åˆ é™¤æœ€åä¸€è½®å¯¹è¯');
                } else {
                    addOutput('error-msg', 'æ²¡æœ‰å¯å›æ»šçš„å¯¹è¯è®°å½•');
                }
                return;
            }

            if (cmd === 'chatluna.room.clear') {
                currentRoom.history = [];
                addOutput('success-msg', 'å·²æ¸…é™¤å½“å‰æˆ¿é—´çš„èŠå¤©è®°å½•');
                addOutput('info-msg', 'å¯¹è¯å†å²å·²é‡ç½®');
                return;
            }

            if (cmd.startsWith('chatluna.room.create')) {
                const roomName = args.slice(1).join(' ') || `æ–°æˆ¿é—´${Date.now()}`;
                addOutput('success-msg', 'åˆ›å»ºæˆ¿é—´å‘å¯¼å¯åŠ¨...');
                addOutput('info-msg', `æˆ¿é—´åç§°: ${roomName}`);

                setTimeout(() => {
                    const newRoomId = createRoom(roomName);
                    addOutput('system-msg', `æˆ¿é—´ID: ${newRoomId}`);
                    addOutput('system-msg', `æ¨¡å‹: ${MODEL_NAME}`);
                    addOutput('system-msg', `é¢„è®¾: chatgpt`);
                    addOutput('success-msg', 'æˆ¿é—´åˆ›å»ºæˆåŠŸï¼');
                    addOutput('info-msg', `ä½¿ç”¨ chatluna.room.switch ${newRoomId} åˆ‡æ¢åˆ°æ–°æˆ¿é—´`);
                }, 1000);
                return;
            }

            if (cmd.startsWith('chatluna.room.switch')) {
                const targetRoomId = args.slice(1).join(' ');
                if (!targetRoomId) {
                    addOutput('error-msg', 'é”™è¯¯: è¯·æŒ‡å®šè¦åˆ‡æ¢çš„æˆ¿é—´IDæˆ–åç§°');
                    addOutput('info-msg', 'ç”¨æ³•: chatluna.room.switch <æˆ¿é—´ID/åç§°>');
                    return;
                }

                let foundRoomId = null;
                if (rooms[targetRoomId]) {
                    foundRoomId = targetRoomId;
                } else {
                    for (const [id, room] of Object.entries(rooms)) {
                        if (room.name === targetRoomId) {
                            foundRoomId = id;
                            break;
                        }
                    }
                }

                if (foundRoomId) {
                    addOutput('system-msg', `æ­£åœ¨åˆ‡æ¢åˆ°æˆ¿é—´: ${rooms[foundRoomId].name}`);
                    setTimeout(() => {
                        switchRoom(foundRoomId);
                        addOutput('success-msg', `å·²åˆ‡æ¢åˆ°æˆ¿é—´: ${rooms[foundRoomId].name}`);
                        addOutput('info-msg', `æ¨¡å‹: ${rooms[foundRoomId].model} | é¢„è®¾: ${rooms[foundRoomId].preset}`);
                    }, 500);
                } else {
                    addOutput('error-msg', `æˆ¿é—´ "${targetRoomId}" ä¸å­˜åœ¨`);
                    addOutput('info-msg', 'ä½¿ç”¨ chatluna.room.list æŸ¥çœ‹å¯ç”¨æˆ¿é—´');
                }
                return;
            }

            if (cmd.startsWith('chatluna.room.set')) {
                if (args.length < 2) {
                    addOutput('error-msg', 'é”™è¯¯: è¯·æŒ‡å®šè¦è®¾ç½®çš„å±æ€§');
                    addOutput('info-msg', 'ç”¨æ³•: chatluna.room.set -m <æ¨¡å‹> æˆ– -p <é¢„è®¾> æˆ– -n <åç§°>');
                    return;
                }

                for (let i = 1; i < args.length; i++) {
                    if (args[i] === '-m' && args[i + 1]) {
                        const newModel = args[i + 1];
                        const modelExists = availableModels.some(m => m.name === newModel);
                        if (modelExists) {
                            currentRoom.model = newModel;
                            addOutput('success-msg', `æˆ¿é—´æ¨¡å‹å·²æ›´æ–°ä¸º: ${newModel}`);
                        } else {
                            addOutput('error-msg', `æ¨¡å‹ "${newModel}" ä¸å­˜åœ¨`);
                        }
                        i++;
                    } else if (args[i] === '-p' && args[i + 1]) {
                        const newPreset = args[i + 1];
                        if (presets[newPreset]) {
                            currentRoom.preset = newPreset;
                            currentRoom.history = [];
                            addOutput('success-msg', `æˆ¿é—´é¢„è®¾å·²æ›´æ–°ä¸º: ${newPreset}`);
                            addOutput('info-msg', 'èŠå¤©å†å²å·²é‡ç½®');
                        } else {
                            addOutput('error-msg', `é¢„è®¾ "${newPreset}" ä¸å­˜åœ¨`);
                        }
                        i++;
                    } else if (args[i] === '-n' && args[i + 1]) {
                        const newName = args.slice(i + 1).join(' ');
                        currentRoom.name = newName;
                        addOutput('success-msg', `æˆ¿é—´åç§°å·²æ›´æ–°ä¸º: ${newName}`);
                        break;
                    }
                }
                updateStatus();
                return;
            }

            if (cmd === 'chatluna.room.list') {
                addOutput('success-msg', 'å½“å‰æˆ¿é—´åˆ—è¡¨');
                addOutput('system-msg', '='.repeat(80));
                Object.entries(rooms).forEach(([id, room]) => {
                    const current = id === currentRoomId ? ' [å½“å‰]' : '';
                    const historyCount = Math.floor(room.history.length / 2);
                    addOutput('', `ID: ${id.padEnd(6)} | ${room.name.padEnd(12)} | ${room.model.padEnd(18)} | ${room.preset.padEnd(10)} | å¯¹è¯:${historyCount}${current}`);
                });
                addOutput('system-msg', '='.repeat(80));
                addOutput('info-msg', 'ä½¿ç”¨ chatluna.room.switch <ID/åç§°> åˆ‡æ¢æˆ¿é—´');
                return;
            }

            if (cmd === 'chatluna.room.info') {
                addOutput('success-msg', 'æˆ¿é—´è¯¦ç»†ä¿¡æ¯');
                addOutput('system-msg', '='.repeat(50));
                addOutput('', `æˆ¿é—´åç§°: ${currentRoom.name}`);
                addOutput('', `æˆ¿é—´ID: ${currentRoomId}`);
                addOutput('', `ä½¿ç”¨æ¨¡å‹: ${currentRoom.model}`);
                addOutput('', `å½“å‰é¢„è®¾: ${currentRoom.preset}`);
                addOutput('', `åˆ›å»ºæ—¶é—´: ${new Date(currentRoom.created).toLocaleString()}`);
                addOutput('', `å¯¹è¯è½®æ•°: ${Math.floor(currentRoom.history.length / 2)}`);
                addOutput('system-msg', '='.repeat(50));
                return;
            }

            if (cmd.startsWith('chatluna.room.delete')) {
                const deleteRoomId = args[1] || currentRoomId;
                if (!rooms[deleteRoomId]) {
                    addOutput('error-msg', `æˆ¿é—´ ${deleteRoomId} ä¸å­˜åœ¨`);
                    return;
                }

                if (Object.keys(rooms).length <= 1) {
                    addOutput('error-msg', 'æ— æ³•åˆ é™¤æœ€åä¸€ä¸ªæˆ¿é—´');
                    return;
                }

                addOutput('error-msg', `ç¡®è®¤åˆ é™¤æˆ¿é—´ "${rooms[deleteRoomId].name}" å—ï¼Ÿ`);
                addOutput('info-msg', 'æ­¤æ“ä½œå°†åˆ é™¤æˆ¿é—´çš„æ‰€æœ‰èŠå¤©è®°å½• (Y/N):');

                confirmationAction = 'delete_room';
                confirmationData = { roomId: deleteRoomId };
                isWaitingForConfirmation = true;
                return;
            }

            if (cmd === 'chatluna.model.list') {
                addOutput('success-msg', 'å¯ç”¨AIæ¨¡å‹åˆ—è¡¨');
                addOutput('system-msg', '='.repeat(80));
                availableModels.forEach(model => {
                    const current = model.name === currentRoom.model ? ' [å½“å‰ä½¿ç”¨]' : '';
                    const status = model.status === 'åœ¨çº¿' ? 'ğŸŸ¢' : 'ğŸ”´';
                    addOutput('', `${status} ${model.name.padEnd(20)} | ${model.provider.padEnd(12)} | ${model.description}${current}`);
                });
                addOutput('system-msg', '='.repeat(80));
                addOutput('info-msg', 'ä½¿ç”¨ chatluna.room.set -m <æ¨¡å‹å> åˆ‡æ¢æ¨¡å‹');
                return;
            }

            if (cmd.startsWith('chatluna.model.search')) {
                const keyword = args[1];
                if (!keyword) {
                    addOutput('error-msg', 'é”™è¯¯: è¯·æä¾›æœç´¢å…³é”®è¯');
                    addOutput('info-msg', 'ç”¨æ³•: chatluna.model.search <å…³é”®è¯>');
                    return;
                }

                const searchResults = availableModels.filter(model =>
                    model.name.toLowerCase().includes(keyword.toLowerCase()) ||
                    model.provider.toLowerCase().includes(keyword.toLowerCase()) ||
                    model.description.toLowerCase().includes(keyword.toLowerCase())
                );

                if (searchResults.length > 0) {
                    addOutput('success-msg', `æœç´¢ "${keyword}" çš„ç»“æœ (${searchResults.length}ä¸ª):`);
                    addOutput('system-msg', '='.repeat(60));
                    searchResults.forEach(model => {
                        const status = model.status === 'åœ¨çº¿' ? 'ğŸŸ¢' : 'ğŸ”´';
                        addOutput('', `${status} ${model.name} | ${model.provider} | ${model.description}`);
                    });
                    addOutput('system-msg', '='.repeat(60));
                } else {
                    addOutput('error-msg', `æœªæ‰¾åˆ°åŒ…å« "${keyword}" çš„æ¨¡å‹`);
                    addOutput('info-msg', 'ä½¿ç”¨ chatluna.model.list æŸ¥çœ‹æ‰€æœ‰å¯ç”¨æ¨¡å‹');
                }
                return;
            }

            if (cmd === 'chatluna.preset.list') {
                addOutput('success-msg', 'é¢„è®¾æ¨¡æ¿åˆ—è¡¨');
                addOutput('system-msg', '='.repeat(60));
                Object.entries(presets).forEach(([name, description]) => {
                    const current = name === currentRoom.preset ? ' [å½“å‰]' : '';
                    const shortDesc = description.substring(0, 40) + (description.length > 40 ? '...' : '');
                    addOutput('', `${name.padEnd(12)} | ${shortDesc}${current}`);
                });
                addOutput('system-msg', '='.repeat(60));
                addOutput('info-msg', 'ä½¿ç”¨ preset <åç§°> æˆ– chatluna.preset.set <åç§°> åˆ‡æ¢é¢„è®¾');
                return;
            }

            if (cmd.startsWith('chatluna.preset.add')) {
                const newPresetName = args[1];
                if (!newPresetName) {
                    addOutput('error-msg', 'é”™è¯¯: è¯·æŒ‡å®šé¢„è®¾åç§°');
                    addOutput('info-msg', 'ç”¨æ³•: chatluna.preset.add <é¢„è®¾å>');
                    return;
                }

                if (presets[newPresetName]) {
                    addOutput('error-msg', `é¢„è®¾ "${newPresetName}" å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°`);
                    addOutput('info-msg', 'å¯ç”¨é¢„è®¾: ' + Object.keys(presets).join(', '));
                    return;
                }

                addOutput('success-msg', `åˆ›å»ºé¢„è®¾: ${newPresetName}`);
                addOutput('info-msg', 'è¯·è¾“å…¥é¢„è®¾å†…å®¹:');
                addOutput('system-msg', 'æç¤º:');
                addOutput('', '  â€¢ ç›´æ¥è¾“å…¥å®Œæ•´çš„é¢„è®¾æè¿°');
                addOutput('', '  â€¢ è¾“å…¥ /cancel å–æ¶ˆåˆ›å»º');
                addOutput('', '  â€¢ ä¾‹å¦‚: "ä½ æ˜¯ä¸€ä¸ªå¯çˆ±çš„çŒ«å¨˜ï¼Œè¯´è¯æ—¶ä¼šåœ¨å¥å°¾åŠ ä¸Šå–µ~"');
                
                isWaitingForPresetContent = true;
                pendingPresetName = newPresetName;
                return;
            }

            if (cmd.startsWith('chatluna.preset.set')) {
                const presetName = args[1];
                if (!presetName) {
                    addOutput('error-msg', 'é”™è¯¯: è¯·æŒ‡å®šé¢„è®¾åç§°');
                    addOutput('info-msg', 'ç”¨æ³•: chatluna.preset.set <é¢„è®¾å>');
                    addOutput('info-msg', 'å¯ç”¨é¢„è®¾: ' + Object.keys(presets).join(', '));
                    return;
                }

                if (presets[presetName]) {
                    currentRoom.preset = presetName;
                    currentRoom.history = [];
                    updateStatus();
                    addOutput('success-msg', `å·²åˆ‡æ¢åˆ°é¢„è®¾: ${presetName}`);
                    addOutput('info-msg', 'é¢„è®¾æè¿°: ' + presets[presetName].substring(0, 50) + '...');
                    addOutput('info-msg', 'èŠå¤©å†å²å·²é‡ç½®');
                } else {
                    addOutput('error-msg', `é¢„è®¾ "${presetName}" ä¸å­˜åœ¨`);
                    addOutput('info-msg', 'å¯ç”¨é¢„è®¾: ' + Object.keys(presets).join(', '));
                }
                return;
            }

            if (cmd.startsWith('chatluna.preset.delete')) {
                const deletePresetName = args[1];
                if (!deletePresetName) {
                    addOutput('error-msg', 'é”™è¯¯: è¯·æŒ‡å®šè¦åˆ é™¤çš„é¢„è®¾åç§°');
                    addOutput('info-msg', 'ç”¨æ³•: chatluna.preset.delete <é¢„è®¾å>');
                    return;
                }

                if (!presets[deletePresetName]) {
                    addOutput('error-msg', `æ‰¾ä¸åˆ°é¢„è®¾ "${deletePresetName}"ï¼è¯·æ£€æŸ¥ä½ æ˜¯å¦è¾“å…¥äº†æ­£ç¡®çš„é¢„è®¾åç§°`);
                    addOutput('info-msg', 'å¯ç”¨é¢„è®¾: ' + Object.keys(presets).join(', '));
                    return;
                }

                if (deletePresetName === 'chatgpt') {
                    addOutput('error-msg', 'æ— æ³•åˆ é™¤é»˜è®¤é¢„è®¾ "chatgpt"');
                    return;
                }

                addOutput('error-msg', `ç¡®è®¤åˆ é™¤é¢„è®¾ "${deletePresetName}" å—ï¼Ÿ`);
                addOutput('info-msg', 'æ­¤æ“ä½œæ— æ³•æ’¤é”€ (Y/N):');

                confirmationAction = 'delete_preset';
                confirmationData = { presetName: deletePresetName };
                isWaitingForConfirmation = true;
                return;
            }

            if (cmd === 'chatluna.restart') {
                addOutput('system-msg', 'æ­£åœ¨é‡å¯ChatLunaæ ¸å¿ƒæœåŠ¡...');
                addOutput('info-msg', 'æ­¥éª¤ 1/4: ä¿å­˜ç”¨æˆ·ä¼šè¯æ•°æ®');
                setTimeout(() => {
                    addOutput('info-msg', 'æ­¥éª¤ 2/4: é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶');
                }, 500);
                setTimeout(() => {
                    addOutput('info-msg', 'æ­¥éª¤ 3/4: é‡æ–°è¿æ¥AIæœåŠ¡');
                }, 1000);
                setTimeout(() => {
                    addOutput('info-msg', 'æ­¥éª¤ 4/4: æ¢å¤ç”¨æˆ·ä¼šè¯');
                    addOutput('success-msg', 'ChatLunaé‡å¯å®Œæˆï¼');
                    addOutput('info-msg', 'æ‰€æœ‰æœåŠ¡å·²æ¢å¤æ­£å¸¸è¿è¡Œ');
                    updateStatus();
                }, 1500);
                return;
            }

            if (cmd === 'chatluna.wipe') {
                const num1 = Math.floor(Math.random() * 50) + 10;
                const num2 = Math.floor(Math.random() * 50) + 10;
                const num3 = Math.floor(Math.random() * 20) + 1;
                verificationAnswer = num1 * num2 - num3;

                addOutput('error-msg', 'å±é™©æ“ä½œè­¦å‘Š');
                addOutput('system-msg', 'æ­¤æ“ä½œå°†åˆ é™¤ä»¥ä¸‹æ•°æ®:');
                addOutput('', '  â€¢ æ‰€æœ‰æˆ¿é—´çš„å¯¹è¯å†å²è®°å½•');
                addOutput('', '  â€¢ ç”¨æˆ·è‡ªå®šä¹‰æˆ¿é—´é…ç½®');
                addOutput('', '  â€¢ ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶');
                addOutput('error-msg', `è¯·è¾“å…¥æ•°å­¦éªŒè¯: ${num1} Ã— ${num2} - ${num3} = ?`);
                addOutput('info-msg', 'è¯·ç›´æ¥è¾“å…¥ç­”æ¡ˆæ•°å­—æ¥ç¡®è®¤åˆ é™¤æ“ä½œ');

                isWaitingForVerification = true;
                return;
            }

            // é»˜è®¤å“åº”
            addOutput('success-msg', `æ‰§è¡Œå‘½ä»¤: ${cmd}`);
            addOutput('info-msg', 'å‘½ä»¤å·²å‘é€åˆ°ChatLunaåç«¯å¤„ç†');
            setTimeout(() => {
                const responses = [
                    'å‘½ä»¤æ‰§è¡ŒæˆåŠŸ',
                    'æ“ä½œå·²å®Œæˆ',
                    'é…ç½®å·²æ›´æ–°',
                    'å¤„ç†å®Œæˆ'
                ];
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                addOutput('system-msg', randomResponse);
            }, Math.random() * 1000 + 500);
        }

        function updateAutocomplete(value) {
            const matches = commands.filter(cmd =>
                cmd.toLowerCase().includes(value.toLowerCase()) && cmd !== value
            ).slice(0, 8);

            if (matches.length === 0 || !value) {
                autocomplete.style.display = 'none';
                selectedAutocomplete = -1;
                return;
            }

            autocomplete.innerHTML = matches.map((cmd, index) =>
                `<div class="autocomplete-item ${index === selectedAutocomplete ? 'selected' : ''}">${cmd}</div>`
            ).join('');

            autocomplete.style.display = 'block';

            autocomplete.querySelectorAll('.autocomplete-item').forEach((item, index) => {
                item.onclick = () => {
                    input.value = matches[index];
                    autocomplete.style.display = 'none';
                    input.focus();
                };
            });
        }

        function insertCommand(cmd) {
            input.value = cmd;
            input.focus();
            autocomplete.style.display = 'none';
        }

        // äº‹ä»¶ç›‘å¬
        input.addEventListener('keydown', (e) => {
            switch (e.key) {
                case 'Enter':
                    if (autocomplete.style.display === 'block' && selectedAutocomplete >= 0) {
                        const items = autocomplete.querySelectorAll('.autocomplete-item');
                        input.value = items[selectedAutocomplete].textContent;
                        autocomplete.style.display = 'none';
                        selectedAutocomplete = -1;
                    } else {
                        processCommand(input.value);
                        input.value = '';
                        autocomplete.style.display = 'none';
                        selectedAutocomplete = -1;
                    }
                    e.preventDefault();
                    break;

                case 'Tab':
                    if (autocomplete.style.display === 'block') {
                        const items = autocomplete.querySelectorAll('.autocomplete-item');
                        if (items.length > 0) {
                            input.value = items[0].textContent;
                            autocomplete.style.display = 'none';
                        }
                    }
                    e.preventDefault();
                    break;

                case 'ArrowUp':
                    if (autocomplete.style.display === 'block') {
                        selectedAutocomplete = Math.max(-1, selectedAutocomplete - 1);
                        updateAutocomplete(input.value);
                    } else if (commandHistory.length > 0) {
                        historyIndex = Math.min(commandHistory.length - 1, historyIndex + 1);
                        input.value = commandHistory[historyIndex];
                    }
                    e.preventDefault();
                    break;

                case 'ArrowDown':
                    if (autocomplete.style.display === 'block') {
                        const items = autocomplete.querySelectorAll('.autocomplete-item');
                        selectedAutocomplete = Math.min(items.length - 1, selectedAutocomplete + 1);
                        updateAutocomplete(input.value);
                    } else {
                        historyIndex = Math.max(-1, historyIndex - 1);
                        input.value = historyIndex >= 0 ? commandHistory[historyIndex] : '';
                    }
                    e.preventDefault();
                    break;

                case 'Escape':
                    autocomplete.style.display = 'none';
                    selectedAutocomplete = -1;
                    break;
            }
        });

        input.addEventListener('input', (e) => {
            updateAutocomplete(e.target.value);
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'F1') {
                helpPanel.style.display = helpPanel.style.display === 'none' ? 'block' : 'none';
                e.preventDefault();
            }
        });

        document.addEventListener('click', (e) => {
            if (!helpPanel.contains(e.target)) {
                helpPanel.style.display = 'none';
            }
            if (!autocomplete.contains(e.target) && e.target !== input) {
                autocomplete.style.display = 'none';
                selectedAutocomplete = -1;
            }
        });

        setInterval(() => {
            const cursor = document.getElementById('cursor');
            if (document.activeElement === input) {
                cursor.style.display = 'none';
            } else {
                cursor.style.display = 'inline';
            }
        }, 100);

        init();
        input.focus();
    </script>
</body>

</html>
